# Galaxy Buds 3 Pro - 노이즈 컨트롤 및 터치 컨트롤 프로토콜

## 1. 노이즈 컨트롤 모드

### 1.1 모드 값

| 값 | 모드 | 설명 |
|----|------|------|
| `0x00` | Off | 노이즈 컨트롤 끄기 |
| `0x01` | ANC | Active Noise Cancelling |
| `0x02` | Ambient Sound | 주변 소리 듣기 |
| `0x03` | Adaptive | 소음 제어 최적화 (자동) |

**참조**: `sources/L7/L.java`, `sources/L7/c0.java:420-426`

---

### 1.2 노이즈 컨트롤 모드 변경

**MSG_ID**: `0x78` (120)

**Payload**: 1 byte

```
[0x78] [mode]
        │
        └─ 0x00=Off, 0x01=ANC, 0x02=Ambient, 0x03=Adaptive
```

**전체 패킷 예시 (ANC 모드로 변경)**:
```
[FD] [04] [00] [78] [01] [CRC_L] [CRC_H] [DD]
 │    │    │    │    │
 │    │    │    │    └─ payload: ANC(1)
 │    │    │    └─ MSG_ID: 0x78
 │    │    └─ len_high
 │    └─ len_low (payload=1 + 3 = 4)
 └─ SOM
```

---

### 1.3 현재 노이즈 컨트롤 모드 읽기

#### 방법 1: Extended Status Request (권장)

**요청 MSG_ID**: `0x61` (97)

**요청 패킷**:
```
[FD] [03] [00] [61] [CRC_L] [CRC_H] [DD]
```

**응답**: 약 100+ 바이트의 상태 정보

**노이즈 컨트롤 모드 위치**: 응답 payload **오프셋 31**

```
응답 payload:
[0]  revision
[1]  ...
...
[31] noiseControls  ← 현재 노이즈 컨트롤 모드 (0-3)
...
```

**참조**: `sources/L7/C0168n.java`

#### 방법 2: 상태 변경 알림 수신

Buds가 노이즈 컨트롤 상태 변경 시 자동으로 전송

**알림 MSG_ID**: `0x77` (119)

**Payload**:
```
[0] noiseControlsUpdate  ← 현재 모드 (0-3)
[1] wearingState         ← 착용 상태
```

**참조**: `sources/L7/M.java`, `sources/L7/C0155a.java:313-325`

---

## 2. 터치 컨트롤

### 2.1 터치 컨트롤 기능 목록

| 인덱스 | 기능 | 설명 |
|--------|------|------|
| 0 | Touch Controls Enable | 터치 컨트롤 전체 On/Off |
| 1 | Pinch Detection | 한 번 집기 감지 |
| 2 | Double Pinch | 두 번 집기 감지 |
| 3 | Triple Pinch | 세 번 집기 감지 |
| 4 | Touch and Hold | 길게 터치 감지 |
| 5 | Pinch for Calls | 통화 중 집기 |
| 6 | Pinch and Hold for Calls | 통화 중 길게 집기 |
| 7 | Swipe Detection | 스와이프 감지 |
| 8 | Additional 1 | 추가 옵션 1 |
| 9 | Additional 2 | 추가 옵션 2 |

**참조**: `sources/L7/C0179z.java`, `sources/Z6/b.java`

---

### 2.2 터치 컨트롤 설정 변경

**MSG_ID**: `0x90` (144, signed: -112)

**Payload**: 10 bytes

```
오프셋  필드                      값
[0]    Touch Controls Enable    0x00=Off, 0x01=On
[1]    Pinch Detection          0x00=Off, 0x01=On
[2]    Double Pinch             0x00=Off, 0x01=On
[3]    Triple Pinch             0x00=Off, 0x01=On
[4]    Touch and Hold           0x00=Off, 0x01=On
[5]    Pinch for Calls          0x00=Off, 0x01=On
[6]    Pinch and Hold for Calls 0x00=Off, 0x01=On
[7]    Swipe Detection          0x00=Off, 0x01=On
[8]    Additional 1             0x00=Off, 0x01=On
[9]    Additional 2             0x00=Off, 0x01=On
```

**전체 패킷 예시 (터치 컨트롤 전체 끄기)**:
```
[FD] [0D] [00] [90] [00] [00] [00] [00] [00] [00] [00] [00] [00] [00] [CRC_L] [CRC_H] [DD]
 │    │    │    │    │
 │    │    │    │    └─ payload: 10 bytes 모두 0x00
 │    │    │    └─ MSG_ID: 0x90
 │    │    └─ len_high
 │    └─ len_low (payload=10 + 3 = 13 = 0x0D)
 └─ SOM
```

**전체 패킷 예시 (터치 컨트롤 전체 켜기, 기본 설정)**:
```
[FD] [0D] [00] [90] [01] [01] [01] [01] [01] [01] [01] [01] [00] [00] [CRC_L] [CRC_H] [DD]
                     │    │    │    │    │    │    │    │    │    │
                     │    │    │    │    │    │    │    │    │    └─ Additional 2
                     │    │    │    │    │    │    │    │    └─ Additional 1
                     │    │    │    │    │    │    │    └─ Swipe
                     │    │    │    │    │    │    └─ Pinch and Hold for Calls
                     │    │    │    │    │    └─ Pinch for Calls
                     │    │    │    │    └─ Touch and Hold
                     │    │    │    └─ Triple Pinch
                     │    │    └─ Double Pinch
                     │    └─ Pinch
                     └─ Touch Controls Enable
```

**참조**: `sources/L7/C0179z.java`

---

### 2.3 현재 터치 컨트롤 상태 읽기

**요청 MSG_ID**: `0x61` (97) - Extended Status Request

**응답 payload 오프셋 17**: 비트 마스크로 인코딩

```
byte b17 = payload[17];

비트  값   기능                      활성화 조건
─────────────────────────────────────────────────
0     1    Touch and Hold           (b17 & 0x01) == 0x01
1     2    Triple Pinch             (b17 & 0x02) == 0x02
2     4    Double Pinch             (b17 & 0x04) == 0x04
3     8    Pinch                    (b17 & 0x08) == 0x08
4     16   Pinch for Calls          (b17 & 0x10) == 0x10
5     32   Pinch and Hold for Calls (b17 & 0x20) == 0x20
6     64   Swipe                    (b17 & 0x40) == 0x40
7     128  Touch Controls Enable    (b17 & 0x80) == 0x80
```

**응답 payload 오프셋 18**: 터치패드 옵션

```
byte b18 = payload[18];

상위 4비트 (b18 >> 4)  : Touch Pad Option Left
하위 4비트 (b18 & 0x0F): Touch Pad Option Right
```

**참조**: `sources/L7/C0168n.java:430-461`

---

## 3. 기타 관련 메시지 ID

| MSG_ID | 값 (hex) | 값 (dec) | 용도 |
|--------|----------|----------|------|
| Noise Controls | 0x78 | 120 | 노이즈 컨트롤 모드 설정 |
| Noise Controls Update | 0x77 | 119 | 노이즈 컨트롤 상태 알림 (Buds→App) |
| Extended Status | 0x61 | 97 | 전체 상태 조회 |
| Status Update | 0x60 | 96 | 간단한 상태 업데이트 |
| Lock Touchpad | 0x90 | 144 | 터치패드 설정 |
| Set Touchpad Option | 0x6E | 110 | 터치패드 옵션 설정 |
| Ambient Sound Level | 0x84 | 132 | Ambient 레벨 (0-4) |
| Noise Reduction Level | 0x83 | 131 | ANC 레벨 (0-4) |
| Set Hot Command | 0x64 | 100 | 터치 동작 매핑 설정 |

---

## 4. 구현 예시 (의사 코드)

### 4.1 노이즈 컨트롤 모드 변경

```python
def set_noise_control(mode):
    """
    mode: 0=Off, 1=ANC, 2=Ambient, 3=Adaptive
    """
    msg_id = 0x78
    payload = bytes([mode])
    packet = build_packet(msg_id, payload)
    send(packet)
```

### 4.2 터치 컨트롤 On/Off

```python
def set_touch_control(enable):
    """
    enable: True=On, False=Off
    """
    msg_id = 0x90

    if enable:
        # 기본 설정으로 활성화
        payload = bytes([0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00])
    else:
        # 모두 비활성화
        payload = bytes([0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00])

    packet = build_packet(msg_id, payload)
    send(packet)
```

### 4.3 현재 상태 조회

```python
def get_current_status():
    """전체 상태 조회"""
    msg_id = 0x61
    payload = bytes([])  # 빈 페이로드
    packet = build_packet(msg_id, payload)
    send(packet)

    response = receive()

    # 노이즈 컨트롤 모드
    noise_mode = response[31]

    # 터치 컨트롤 상태
    touch_byte = response[17]
    touch_enabled = (touch_byte & 0x80) != 0
    pinch_enabled = (touch_byte & 0x08) != 0
    double_pinch_enabled = (touch_byte & 0x04) != 0
    triple_pinch_enabled = (touch_byte & 0x02) != 0
    touch_hold_enabled = (touch_byte & 0x01) != 0

    return {
        'noise_mode': noise_mode,
        'touch_enabled': touch_enabled,
        'pinch': pinch_enabled,
        'double_pinch': double_pinch_enabled,
        'triple_pinch': triple_pinch_enabled,
        'touch_hold': touch_hold_enabled
    }
```

### 4.4 패킷 빌더

```python
def build_packet(msg_id, payload):
    """SPP 패킷 생성"""
    SOM = 0xFD
    EOM = 0xDD

    length = len(payload) + 3  # MSG_ID(1) + payload(N) + CRC(2)
    len_low = length & 0xFF
    len_high = (length >> 8) & 0xFF

    # CRC 계산 대상: MSG_ID + payload
    crc_data = bytes([msg_id]) + payload
    crc = crc16(crc_data)
    crc_low = crc & 0xFF
    crc_high = (crc >> 8) & 0xFF

    packet = bytes([SOM, len_low, len_high, msg_id]) + payload + bytes([crc_low, crc_high, EOM])
    return packet
```

---

## 5. 참조 파일

```
galaxy_buds3_pro_manager_decompiled/sources/

L7/
├── L.java              ★ 노이즈 컨트롤 메시지 (MSG_ID: 0x78)
├── M.java              # 노이즈 컨트롤 업데이트 (MSG_ID: 0x77)
├── C0168n.java         ★ Extended Status 응답 파싱
├── C0179z.java         ★ 터치패드 설정 (MSG_ID: 0x90)
├── c0.java             # 응답 처리 (라인 420-426: 노이즈, 82-306: 터치)
└── C0155a.java         # 메시지 베이스 클래스

Z6/
└── b.java              ★ 디바이스 상태 저장
                          - l0: 노이즈 컨트롤 모드
                          - f9504x0: 터치 컨트롤 활성화
                          - f9491q0: 핀치 감지
                          - f9493r0: 더블 핀치
                          - s0: 트리플 핀치
                          - f9502w0: 터치 앤 홀드
```

---

*분석일: 2026-01-20*
*이 문서로 Galaxy Buds 3 Pro 노이즈 컨트롤 및 터치 컨트롤 구현 가능*
